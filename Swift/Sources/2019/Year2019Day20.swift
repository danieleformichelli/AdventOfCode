// Created by Daniele Formichelli.

import Utils

/// https://adventofcode.com/2019/day/20
struct Year2019Day20: DayBase {
  func part1(_ input: String) -> CustomDebugStringConvertible {
    let status = initialStatus(input, splitMap: false)

    var costCache: [Status: Int] = [:]
    return self.collect(status: status, costCache: &costCache)
  }

  func part2(_ input: String) -> CustomDebugStringConvertible {
    let status = initialStatus(input, splitMap: true)

    var costCache: [Status: Int] = [:]
    return self.collect(status: status, costCache: &costCache)
  }

  private func collect(status _: Status, costCache _: inout [Status: Int]) -> Int {
    0
//    guard status.remainingKeys.count > 0 else {
//      // search completed
//      return 0
//    }
//
//    if let cached = costCache[status] {
//      // solution already found for this status
//      return cached
//    }
//
//    // iterate on nearest key first to find low cost solution as soon as possible
//    var lowestCost = Int.max
//    for currentPositionIndex in 0..<status.currentPositions.count {
//      // for each starting position
//      for (key, stepCost) in status.reachableKeysAndCost(from: currentPositionIndex).sorted(by: { $0.value < $1.value }) {
//        // for each reachable key
//        let nextStatus = status.collecting(key: key, from: currentPositionIndex, withCost: stepCost)
//
//        // calculate the cost from the next position adding the cost for reaching that key
//        let remainingPathCost = self.collect(status: nextStatus, costCache: &costCache)
//        let totalCost = stepCost + remainingPathCost
//        lowestCost = min(lowestCost, totalCost)
//      }
//    }
//
//    // store the result in cache to avoid to recompute it over and over
//    costCache[status] = lowestCost
//    return lowestCost
  }
}

private struct Status: Hashable {
  let map: [Point: Element]
  let currentPositions: [Point]

  func collecting(key _: Point, from _: Int, withCost _: Int) -> Status {
    self
//    var remainingKeys = self.remainingKeys
//    remainingKeys.remove(key)
//
//    let collectedKey: String
//    let element = self.map[key]
//    switch element {
//    case .key(let letter):
//      collectedKey = letter
//    default:
//      fatalError("No key at position \(key)")
//    }
//    var collectedKeys = self.collectedKeys
//    collectedKeys.insert(collectedKey)
//
//    var map = self.map
//    map[key] = .empty
//
//    var newPositions = self.currentPositions
//    newPositions[index] = key
//
//    return Status(
//      map: map,
//      currentPositions: newPositions,
//      remainingKeys: remainingKeys,
//      collectedKeys: collectedKeys
//    )
  }

  //  func reachableKeysAndCost(from index: Int) -> [Point: Int] {
//    var keysAndCost: [Point: Int] = [:]
//    var pointsToExplore: [Point: Int] = [self.currentPositions[index]: 0]
//    var exploredPoints: Set<Point> = []
//
//    while !pointsToExplore.isEmpty {
//      let pointAndCost = pointsToExplore.remove(at: pointsToExplore.startIndex)
//      let point = pointAndCost.key
//      let nextCost = pointAndCost.value + 1
//      exploredPoints.insert(point)
//      Direction.allCases.forEach { direction in
//        let nextInDirection = Point(x: point.x + direction.dx, y: point.y + direction.dy)
//        guard !exploredPoints.contains(nextInDirection) else { return }
//        let element = self.map[nextInDirection]!
//        switch element {
//        case .empty, .entrance:
//          break
//        case .door(let letter) where self.collectedKeys.contains(letter):
//          break
//        case .key:
//          keysAndCost[nextInDirection] = nextCost
//          return
//        default:
//          return
//        }
//
//        pointsToExplore[nextInDirection] = nextCost
//      }
//    }
//
//    return keysAndCost
  //  }
}

private enum Element: MapElement, Hashable {
  case empty
  case wall
  case portal(String)

  var representation: String {
    switch self {
    case .empty:
      return "⬜️"
    case .wall:
      return "⬛️"
    case .portal:
      return "🚪"
    }
  }
}

extension Year2019Day20 {
  private func initialStatus(_ input: String, splitMap _: Bool) -> Status {
    var map: [Point: Element] = [:]
    var entrance: Point = .zero
    var remainingPortals: Set<Point> = []

    let inputLines = input.lines
    for (y, line) in inputLines.enumerated() {
      for (x, char) in line.enumerated() {
        var point = Point(x: x, y: y)
        let element: Element
        switch char {
        case ".":
          element = .empty
        case "#":
          element = .wall
        case "A" ... "Z":
          (point, element) = self.parsePortal(from: inputLines, at: point)
        default:
          continue
        }

        map[point] = element

        switch element {
        case .empty, .wall:
          break
        case .portal(let name):
          remainingPortals.insert(point)
          if name == "AA" {
            entrance = point
          }
        }
      }
    }

    return Status(map: map, currentPositions: [entrance])
  }

  private func parsePortal(from lines: [String], at point: Point) -> (point: Point, element: Element) {
    var letters: [String] = []
    var point: Point = .zero

    for x in point.x - 1 ... point.x + 1 {
      for y in point.y - 1 ... point.y + 1 {
        guard y >= 0, y < lines.count else { continue }
        let line = lines[y]
        guard x >= 0, x < line.count else { continue }

        let char = line[line.index(line.startIndex, offsetBy: x)]
        switch char {
        case Element.empty.representation.first!:
          point = Point(x: x, y: y)
        case Element.wall.representation.first!, " ":
          break
        case "A" ... "Z":
          letters.append(String(char))
        default:
          break
        }
      }
    }

    let portalName = letters.sorted().joined(separator: "")
    return (point: point, element: .portal(portalName))
  }

  var input: String {
    """
                                           X       Q J     A J           T     Z   I
                                           Y       L X     A J           V     L   Q
      #####################################.#######.#.#####.#.###########.#####.###.###################################
      #...#.......#.#.....#...#.#.#...#...#.#.......#.......#.#.....#.....#...#...#.#.#...#...#.#...#...........#.....#
      #.#.#######.#.###.#####.#.#.###.#.#.#.#.#######.#####.#.#.###.###.###.#.###.#.#.#.###.###.#.###.###.#.#####.#.###
      #.#.#.#...#...#...#.......#.#.....#...#...#.#...#...#.#.#.#...#.#.#.#.#.....#...................#.#.#.#.....#.#.#
      #.###.#.#####.###.#####.###.###.#########.#.###.###.#.#.#.#.###.#.#.#.#########.#######.###.#####.#########.###.#
      #.........#.......#.....................#.....#.#.....#...#.....#...#.#...#.#.#.....#.#.#.......#...#...........#
      #####.###########.#####.###.#########.#######.#######.#####.#####.###.#.###.#.#.#####.#.###.#.###.#.#####.#.###.#
      #.........#...#.#.......#.#...#.#.#...#...........#...#...#...#.....#...#...#.........#.#.#.#.....#.......#.#.#.#
      #####.#.###.###.#.#.#####.#.###.#.#.###.###########.###.#.###.#.#.#####.#.#.#.###########.###.###.###.###.###.###
      #.#.#.#.#.........#.#.........#.....#.#.........#.#...#.#.#...#.#.#.....#.#.#...............#...#.#.#...#.......#
      #.#.###.###.#######.###############.#.#####.#.###.###.#.#.#.###.#######.#.#.#.#.#.#.###.###.#.#.#.#.#####.#######
      #.......#.#.#...#.#.#.#...#.....#.#.......#.#.#.......#.#.....#...#.......#.#.#.#.#...#...#.#.#.#...#.#.#.#.....#
      #######.#.#####.#.###.###.###.###.#.#######.#.###.#.###.#########.###.#####.###.#####################.#.#####.#.#
      #.......#.....#.#.#.#.....#.#...#.......#...#.#.#.#...#...#.......#.#.....#.#.#...#.#.............#...#...#.#.#.#
      #######.###.###.#.#.#.###.#.###.#.#.#########.#.###.#.#.#######.#.#.#.#####.#.#.###.#.###.#########.###.###.#.###
      #.#.#.#.#.#...#...#...#...........#.....#.........#.#.#.#.....#.#...#.....#.#.#.......#...................#.#...#
      #.#.#.#.#.#.#.###.#####.#.#.###.#########.###.#######.#.###.###.#####.#####.#.#.###.#.#####.#.###.###.#####.#.###
      #.......#.#.#.#.#...#.#.#.#.#.#.....#.#.#.#...#.#.....#.....#.....#...#...#.#...#.#.#.....#.#...#...#...#.#.#...#
      #####.###.#.###.###.#.###.###.###.###.#.#.###.#.#.#######.#.#.#.#########.#.###.#.###.#######.###########.#.#.#.#
      #.#.......#...#.#.....#...#.#...........#.#.#.#.....#.#...#.#.#...#.#.......#.....#.#...#.......#...........#.#.#
      #.###.#####.#.#.###.#######.###.###########.#.#.#.###.#.#######.###.#.#####.#.###.#.#.#######.#.###.#.#.#####.###
      #.......#...#.#.#.#...#.#.........#.#.....#...#.#.#.#.....#.........#.#.....#.#.....#.#...#.#.#.....#.#.#.......#
      #.###.###.#####.#.#.###.###.#.#.###.#####.#.###.###.#####.###.#.#######.###.#.#####.#####.#.#####.###.#####.#.###
      #.#.#.#...#.#.......#...#.#.#.#.#...#.#.......#.....#.......#.#...#.....#...#...#.#...#.....#...#.#.#.......#...#
      #.#.###.#.#.#####.#####.#.#####.###.#.#.###.#######.###.#.#####.#######.###.#.###.#######.#####.###.#####.#######
      #.....#.#...#...#.#.#.......#.#.#.....#.#...#.......#.#.#.#...#.#.....#.#...#.........#...#.#...#...#...#.#.#...#
      ###.#######.###.#.#.###.#.###.#.#####.#####.#.#.#.###.#.#####.#.#####.#####.###.#.#.###.#.#.###.#.###.###.#.###.#
      #.......#...#.#.....#.#.#.#...........#.....#.#.#.....#...#...........#.....#...#.#...#.#...#...........#.#.#...#
      ###.###.###.#.#####.#.#.###.#####.#######.#########.#####.#########.###.#######.#########.###.#.#######.###.###.#
      #...#.#.#.#.....#.#.#.#...#.#    B       X         K     Z         J   Q       X    #...#...#.#.#.....#.#...#...#
      #.#.#.###.#.#####.#.#.#.#####    B       T         H     P         W   J       Y    #.###.#####.#.#.#####.###.#.#
      #.#...#.#.....#.#.....#...#.#                                                       #.#.#...#...#.#...#.#.#...#.#
      ###.#.#.#####.#.#.#.###.###.#                                                       #.#.#.###.#.###.###.#.###.###
      #.#.#.#...#.#.#.#.#...#.....#                                                     XJ..#.......#.#.#...#.......#.#
      #.#.###.###.#.#.###.#####.###                                                       #.#.#.#.#.###.#.###.#######.#
      #...........#................LO                                                     #...#.#.#.............#.#...#
      #.#######.#.#.#.###.###.###.#                                                       #.#.###.#.#.###.###.###.###.#
      #...#...#.#.#.#.#...#.....#.#                                                       #.#...#.#.#.#...#...#...#...#
      ###.#######.#.#####.#.#####.#                                                       #######.###.#####.#.#.#.###.#
      #.#.....#.......#.#.#...#...#                                                       #.#...#...#.#.#...#...#......PF
      #.###.###.#.#.###.###.#.#####                                                       #.###.#######.###############
    QS......#.#.#.#.#.....#.#.#...#                                                       #...#.........#..............QJ
      #######.###.#.#####.#####.###                                                       #.#.#.#######.#.#.#####.#.#.#
      #.........#.#...#...........#                                                       #.#.#.......#...#.....#.#.#.#
      #.#.###.#############.#.#.###                                                       #.#.#######.###.#.#.###.###.#
    WZ..#.#.......#.#.#.#...#.#...#                                                     JX..#...#...#...#.#.#.#...#.#.#
      ###.#######.#.#.#.###.#.#.#.#                                                       ###.#.#.#.#.#############.###
      #...#...#.#.#.......#.#.#.#..QS                                                     #...#...#.....#.#.#...#.....#
      #######.#.#.###.###.#.#.#.#.#                                                       ###############.#.###.###.###
      #...#...#.#.......#...#.#.#.#                                                     WZ..#.#...............#.......#
      #.#####.#.###################                                                       #.#.#.###.###.###.#.#.#.###.#
      #.....#...#.#...............#                                                       #.......#.#...#...#...#...#..NV
      #.###.#.#.#.#.###.#.###.###.#                                                       #########.#######.###########
      #.#.....#.......#.#.#.#.#...#                                                     PJ......#.#...#...#.#.........#
      #.#####.#.#.#.#######.#.#.#.#                                                       ###.#.#.#####.###.#####.#.###
    ZS......#.#.#.#.......#...#.#.#                                                       #...#.#.....#.#.#.#.....#....LO
      #.###########.###.#.#.#####.#                                                       ###.###.###.#.#.#####.#####.#
      #.#.#...#.....#.#.#.#...#.#..IQ                                                     #.........#.#.#.#...#.....#.#
      ###.#.#######.#.#########.###                                                       #######.#####.#.###.#####.###
      #...#.......#.#...#...#......ZS                                                     #...#.....................#.#
      #.#.#.#.#######.#.#.#####.#.#                                                       #.#########################.#
      #.#.#.#.....#...#...#...#.#.#                                                     TV..#...#...#.................#
      #.#.#.#.#########.#####.###.#                                                       #.#.#.###.#.###########.#.#.#
      #.#...#.......#.........#...#                                                       #.#.#.....#.........#.#.#.#..KH
      #.###.###.#.#####.#####.#.###                                                       #.#.#####.#.#########.#.###.#
    GE....#.#...#...........#...#.#                                                       #.#.....#.........#.......#.#
      #.###.###.###.###.#########.#                                                       #.#####.###.###########.###.#
      #.#.#...#...#...#.#.#...#....QW                                                     #.........#.#...#...#.#.#...#
      ###.#########.#####.#.#.#.###                                                       #############.###.###.#.#.#.#
      #.#.#.....#.#.#.#.....#.#...#                                                       #.......#.#...........#.#.#.#
      #.#.###.###.###.#.#.###.###.#                                                       #.###.#.#.#.#.#######.#######
      #.#.#.#.#.#.......#.#.....#.#                                                       #...#.#.....#.#.......#......QW
      #.#.#.#.#.#.###.###.#####.#.#                                                       #.#####.#.#.#.#.###########.#
    ST............#.#.#.#.#.#.....#                                                     NV....#.#.#.#.#.#.#.......#...#
      #########.#.#.###.###.#######                                                       #.###.#.#.#####.#.#.###.#.#.#
      #.......#.#.#.....#.........#                                                       #.....#.#.#.......#.#.....#.#
      ###.#.#######.###.#.#####.#.#                                                       #######.#######.#############
      #...#.#...#.....#.....#...#.#                                                     ZL....#.......#.......#...#.#..XJ
      #.###.#.#.###.###.###.#####.#                                                       #.#########.###########.#.#.#
      #...#...#.....#.#...#.#......QL                                                     #.......#.#.#.......#.....#.#
      ###.#.#.#.#.#.#.#.###.#.#.#.#                                                       #.#######.#######.#####.###.#
    HE....#.#.#.#.#...#...#.#.#.#.#                                                       #.#.#...........#.........#.#
      #.#.###.###.#.###.###.#.###.#                                                       #.#.#.#.#.#.#####.###.###.#.#
      #.#.#...#...#.#.#.#.#.#.#...#                                                       #.....#.#.#.........#...#...#
      #.###.#####.###.#.#.#.###.#.#      G       P   S       O H             J   H        #.###.#########.###.###.#####
      #.#...#.........#...#...#.#.#      E       F   T       H E             J   G        #...#.#...#.....#.#...#.....#
      ###.#.###.#.#.###.#.###############.#######.###.#######.#.#############.###.#########.###.###.#.#.###.#.#######.#
      #...#.#...#.#.#.#.#...#.....#.......#.#.#.....#.#.....#.#...........#.#.#.........#.....#.#.....#.#.....#.#.#.#.#
      ###.#.###.###.#.#.#######.#######.###.#.#.###.#.###.#.#.#######.#.###.#.#######.###.#.#.#####.#####.###.#.#.#.###
      #...#...#.#.....#.#.#.............#.#.....#.....#...#...#.......#...#.#.....#.#...#.#.#...#.....#...#.........#.#
      #.#.###.#.#.###.###.###.#####.###.#.#.###.#####.#.#######.#########.#.#.###.#.#.#########.###.#.###.###.#.#.###.#
      #.#...#.#.#.#.......#.#.#.#.#...#...#.#.......#.#.#...#...........#.#.....#.#.#.#.......#.#...#.#...#...#.#.#.#.#
      #.#.#####.#.###.#.#.#.###.#.#####.#########.#.###.#.#.#.###.###.#####.#.#####.#.#.#############.#.#.###.###.#.#.#
      #.#...#...#...#.#.#.#.....#.#...#.#.#.#.....#.#...#.#.#.#...#.......#.#.....#...........#.#.#.#.#.#.#.....#.....#
      ###.#.#######.#.#########.#.###.#.#.#.###.#####.#.#.#.#########.#.#####.#####.###.###.###.#.#.#.#.#.#.###.###.#.#
      #...#.......#.#.#...#.#.............#.........#.#...#...#.#.....#...#.#.#...#.#.#...#...#.....#.#.#.#.#...#...#.#
      #.#.###.###########.#.#.#.#.#####.#######.#####.#######.#.###.#######.#.#.#.#.#.#####.#####.#####.#####.#.###.###
      #.#.#.#.#.#.#...#.......#.#...#.#.#.#.........#.#.....#...#.......#.#...#.#.....#.#.#.........#.#.....#.#.#.....#
      #.#.#.#.#.#.###.###.###.###.###.#.#.#####.#######.###.#.#.#.###.###.###.#.#.###.#.#.#####.###.#.#.#####.###.#####
      #.#.#.....#...........#...#.#...#.#.......#.....#.#.#...#.#.#...#.#.....#.#.#.#.....#...#...#...#...#...#.......#
      #.#.#####.###.#.#####.###.#####.#.###.###.###.#.#.#.###########.#.#.#.###.###.#####.#.###.###.#.#.#.#.###.#.#.###
      #.#.#.....#...#.#.......#.#.........#.#...#...#...#.....#...#.#...#.#.#.........#.....#...#...#.#.#.#...#.#.#...#
      ###############.#####.###########.###.#.#.#######.#.#######.#.#.###.#.#.###.#####.#.###.#.#######.#########.#.###
      #.....#.........#.#.#...#...........#.#.#.....#...#.#.#.#.........#.#.#.#.......#.#.#.#.#.......#.....#.#...#.#.#
      #####.#.#####.#.#.#.#########.###.#######.###.###.###.#.###.###.#####.###.#####.#####.###.#############.#.###.#.#
      #...........#.#.#.....#.......#.....#.#.#.#...#.#.#.#.....#.#...#.#.....#...#...........#.#.#.......#.....#.....#
      #.#####.#####.###.###.#####.###.#.#.#.#.###.###.#.#.#.#.#######.#.#####.#.#####.###.#.#####.#.#######.###.#######
      #.#.......#.#.#...#...........#.#.#...#.......#.......#.#.#.......#...#.#.....#...#.#.#...#.......#...#.........#
      ###.###.#.#.###.#.###.###########.###.#####.###.#####.###.###.#.#####.#.###.#.#########.###.#.###########.#.###.#
      #...#...#.#.....#...#...#.#.#.#.....#.#.......#.#...........#.#.#.....#.#...#.#...#.......#.#...#.#...#.#.#...#.#
      #.#####.#####.#.#.#######.#.#.###.#######.#######.###.###.#####.#.###.#.#.#######.#######.###.###.#.###.###.#.#.#
      #.#.#...#.....#.#...#.........#...#.....#.#.#.....#.#...#.#.#.#.#...#...#.#.#.#.#...#.....................#.#.#.#
      #.#.#.###.###.#.#.###.#.#.#.#.###.#.###.#.#.#.###.#.#######.#.#.###.###.#.#.#.#.#.###.###.#.#.#####.#.#.#####.###
      #.#.....#.#...#.#...#.#.#.#.#.......#...#...#.#.........#.......#.....#.#...............#.#.#.....#.#.#.....#...#
      #####################################.###.#.#######.#########.#.#.###########.###################################
                                           Z   O J       B         Z P H           X
                                           P   H W       B         Z J G           T
    """
  }
}
